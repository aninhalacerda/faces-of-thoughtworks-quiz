"use strict";angular.module("facesQuizApp.service",["ngCookies","collection"]),angular.module("facesQuizApp",["facesQuizApp.service"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/home.html",controller:"HomeCtrl"}).when("/error",{templateUrl:"views/error.html"}).when("/admin/:office/people",{templateUrl:"views/admin/people.html",controller:"AdminPeopleCtrl",resolve:{office:["$http","$route","$q","$location",function(a,b,c,d){var e=c.defer();return a.get("api/"+b.current.params.office+".json").success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a,b),d.path("/error")}),e.promise}]}}).when("/game/:office",{templateUrl:"views/game.html",controller:"MainCtrl",resolve:{office:["$http","$route","$q","$location",function(a,b,c,d){var e=c.defer();return a.get("api/"+b.current.params.office+".json").success(function(a){e.resolve(a)}).error(function(a,b){e.reject(a,b),d.path("/error")}),e.promise}]}}).otherwise({redirectTo:"/"})}]),angular.module("facesQuizApp").directive("twScrollTo",[function(){return{link:function(a,b,c){a.$watch(function(a){return a.$eval(c.twScrollTo)},function(a){var c,d=b.children(),e=parseInt(a,10);e>=0&&d.length>0&&(c=angular.element(d[e]),b.animate({scrollTop:60*(e/6)-60}))})}}}]).controller("AdminPeopleCtrl",["$scope","office","$routeParams",function(a,b){var c;a.office=b,a.model={},a.model.person={},a.cancel=function(){a.model.person.name=c,a.model.person={}},a.edit=function(b){a.model.person=b,c=b.name},a.save=function(){a.model.person={}}}]).controller("HomeCtrl",["$scope","$http","ArrayCollection",function(a,b,c){a.model={offices:[],selected:void 0},b.get("api/offices.json").then(function(b){a.model.offices=new c(b.data),a.model.offices.shuffle()})}]),angular.module("facesQuizApp").controller("MainCtrl",["$scope","localStorage","Game","office",function(a,b,c,d){function e(){a.foundIndex=a.game.challengePersonIndex(),k[a.foundIndex]="fadeIn"}function f(){j=[]}function g(){b.clearSavedPeople(a.office.slug),k=[]}function h(){b.savePerson(a.office.slug,a.game.challengePerson)}function i(c){for(var d=b.getSavedPeople(a.office.slug),e=[],f=0;f<c.length;f++)d.indexOf(c[f].id)>=0&&(e.push(c[f]),k[f]="fadeIn");return e}var j,k=[];a.office=d,a.game=new c(d.slug,d.people,i(d.people)),a.game.on("start",function(){f()}),a.game.on("turn",function(){f()}),a.game.on("point",function(){h(),f(),e()}),a.game.on("reset",function(){b.clearEndGame(a.office.name),g()}),a.game.on("gameover",function(){b.saveEndGame(a.office.name)}),a.game.start(),a.reset=function(){a.game.reset()},a.guess=function(b,c){j[c]||(j[c]="miss",a.game.guessPerson(b))},a.cssFaceAt=function(a){return j[a]},a.cssMiniFaceAt=function(a){return k[a]}}]),angular.module("collection",[]).filter("shuffle",function(){return function(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}}).factory("ArrayFilter",["ArrayCollection",function(a){var b,c=function(a){b=a};return c.prototype.execute=function(c){var d=new a;return c.each(function(a){b(a)&&d.add(a)}),d},c}]).factory("ArrayCollection",["$filter",function(a){var b=function(a){this.items=a&&a.slice?a.slice():[]};return b.prototype.isEmpty=function(){return 0===this.size()},b.prototype.size=function(){return this.items.length},b.prototype.add=function(a){this.items.push(a)},b.prototype.remove=function(a){var b=this.itemIndex(a);this.items.splice(b,1)},b.prototype.getAt=function(a){return this.items[a]},b.prototype.getNext=function(a){var b=this.itemIndex(a)+1;return this.getAt(b)},b.prototype.getPrevious=function(a){var b=this.itemIndex(a)-1;return this.getAt(b)},b.prototype.getLast=function(){return this.getAt(this.size()-1)},b.prototype.haveNext=function(a){return this.itemIndex(a)+1<this.size()},b.prototype.havePrevious=function(a){return this.itemIndex(a)>0},b.prototype.contains=function(a){return this.itemIndex(a)>=0},b.prototype.itemIndex=function(a){var b=this.items.indexOf(a);if(b>=0)return b;for(var c=0;c<this.items.length;c++)if(this.items[c].hasOwnProperty("id")&&a.hasOwnProperty("id")&&this.items[c].id===a.id){b=c;break}return b},b.prototype.notContains=function(a){return!this.contains(a)},b.prototype.getRandom=function(){return this.getAt(Math.floor(Math.random()*this.size()))},b.prototype.each=function(a){for(var b=0;b<this.size();b++){var c=this.getAt(b);a.call(this,c)}},b.prototype.shuffle=function(){this.items=a("shuffle")(this.items)},b.prototype.sample=function(a){var c=new b(this.items);return c.shuffle(),c.items=c.items.splice(0,a),c},b}]),angular.module("facesQuizApp.service").factory("Game",["Statistics","Crowd","PubSub",function(a,b,c){var d=function(c,d,e){this.statistics=new a(c),this.people=new b(d,e),this.name=c};return d.prototype=new c,d.prototype.constructor=d,d.prototype.start=function(){this.people.isThereAnyAvaliablePeople()?(this.firstTurn(),this.broadcast("start",this)):this.endGame()},d.prototype.firstTurn=function(){this.ended=!1,this.nextTurn()},d.prototype.reset=function(){this.ended=!1,this.statistics.reset(),this.people.reset(),this.challengePerson=void 0,this.challengeGroup=void 0,this.firstTurn(),this.broadcast("reset",this)},d.prototype.guessPerson=function(a){this.isRightGuess(a)?(this.point(),this.endTurn()):this.mistake()},d.prototype.challengePersonIndex=function(){return this.people.all.itemIndex(this.challengePerson)},d.prototype.isRightGuess=function(a){return a===this.challengePerson},d.prototype.point=function(){this.statistics.point(),this.people.ignore(this.challengePerson),this.broadcast("point",this.challengePerson)},d.prototype.mistake=function(){this.broadcast("mistake",this.challengePerson),this.statistics.mistake()},d.prototype.endTurn=function(){this.people.isThereAnyAvaliablePeople()?this.nextTurn():this.endGame()},d.prototype.endGame=function(){this.ended=!0,this.broadcast("gameover",this)},d.prototype.nextTurn=function(){this.challengePerson=this.people.getOneAvaliable(),this.challengeGroup=this.people.sample(4,this.challengePerson.gender),this.challengeGroup.notContains(this.challengePerson)&&(this.challengeGroup.remove(this.challengeGroup.getLast()),this.challengeGroup.add(this.challengePerson)),this.challengeGroup.shuffle(),this.broadcast("turn",this)},d}]),angular.module("facesQuizApp.service").factory("Crowd",["ArrayCollection","ArrayFilter",function(a){var b=function(b,c){var d=this;this.all=new a(b||[]),this.ignoredPeople=new a(c||[]),this.avaliablePeople=new a([]),this.all.each(function(a){d.ignoredPeople.notContains(a)&&d.avaliablePeople.add(a)})};return b.prototype.size=function(){return this.all.size()},b.prototype.isThereAnyAvaliablePeople=function(){return this.ignoredPeople.size()<this.all.size()},b.prototype.getOneAvaliable=function(){return this.avaliablePeople.getRandom()},b.prototype.isPersonIgnored=function(a){return this.avaliablePeople.notContains(a)&&this.ignoredPeople.contains(a)},b.prototype.sample=function(a,b){return b?this.sampleOfGender(a,b):this.sampleOfEveryone(a)},b.prototype.sampleOfEveryone=function(a){return this.all.sample(a)},b.prototype.sampleOfGender=function(b,c){for(var d=new a;d.size()<b;){var e=this.all.getRandom();d.notContains(e)&&e.gender===c&&d.add(e)}return d},b.prototype.ignore=function(a){this.ignoredPeople.add(a),this.avaliablePeople.remove(a)},b.prototype.reset=function(){this.avaliablePeople=new a(this.all.items),this.ignoredPeople=new a},b}]),angular.module("facesQuizApp.service").factory("Statistics",["$cookieStore",function(a){var b=function(a){this.name=a,this.load(),this.update()};return b.prototype.point=function(){this.score++,this.update(),this.save()},b.prototype.mistake=function(){this.mistakes++,this.update(),this.save()},b.prototype.update=function(){this.percentage=100/(this.score+this.mistakes)*this.score||0},b.prototype.reset=function(){this.score=0,this.mistakes=0,this.update(),this.save(this)},b.prototype.load=function(){this.isPersisted()?this.loadStatistics():this.createStatistics()},b.prototype.save=function(){a.put(this.name+"_score",this.score),a.put(this.name+"_mistakes",this.mistakes)},b.prototype.isPersisted=function(){return void 0!==a.get(this.name+"_score")&&void 0!==a.get(this.name+"_mistakes")},b.prototype.loadStatistics=function(){this.score=a.get(this.name+"_score"),this.mistakes=a.get(this.name+"_mistakes")},b.prototype.createStatistics=function(){this.reset()},b}]),angular.module("facesQuizApp.service").factory("PubSub",["$rootScope",function(a){var b=function(){this.trigger=a.$new(),this.listener=this.trigger.$new(!0)};return b.prototype.on=function(a,b){this.listener.$on(a,function(c,d){b(a,d)})},b.prototype.off=function(a){this.listener.$$listeners[a]=void 0},b.prototype.broadcast=function(a,b){this.trigger.$broadcast(a,b)},b}]),angular.module("facesQuizApp.service").service("thoughtworkers",["$q","$http",function(a,b){var c;this.query=function(){return this.shouldQuery()&&this.queryPeople(),c.promise},this.shouldQuery=function(){return void 0===c},this.queryPeople=function(){c=a.defer(),b.get("api/thoughtworkers.json").success(function(a){c.resolve(a)}).error(function(a,b){c.reject(a,b)})}}]),angular.module("facesQuizApp.service").service("localStorage",["$cookieStore",function(a){this.clearSavedPeople=function(b){a.remove(b+"_recognized_people")},this.getSavedPeople=function(b){return a.get(b+"_recognized_people")||[]},this.savePerson=function(b,c){var d=this.getSavedPeople(b);d.push(c.id),a.put(b+"_recognized_people",d)},this.saveEndGame=function(b){a.put(b+"ended",!0)},this.clearEndGame=function(b){a.put(b+"ended",!1)}}]);